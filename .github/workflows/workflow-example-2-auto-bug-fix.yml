# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 2: ë²„ê·¸ ìë™ ìˆ˜ì •
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-2-auto-bug-fix.yml .github/workflows/auto-bug-fix.yml
#
# ëª©ì : 'bug' ë¼ë²¨ì´ ë¶™ì€ ì´ìŠˆì— ëŒ€í•´ ìë™ ìˆ˜ì • ì‹œë„
# íš¨ê³¼:
# - âš¡ ì¦‰ê°ì ì¸ ë²„ê·¸ ëŒ€ì‘
# - ğŸ¤– ë°˜ë³µì ì¸ ë²„ê·¸ëŠ” ìë™ í•´ê²°
# - â° ê°œë°œì ì‹œê°„ ì ˆì•½

name: Auto Bug Fix

on:
  issues:
    types: [labeled, opened]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  # Claude Code workflowë¥¼ ì§ì ‘ í˜¸ì¶œ (workflow_call ì‚¬ìš©)
  auto-fix:
    # 'bug' ë¼ë²¨ì´ ìˆê±°ë‚˜, ì œëª©ì— [BUG]ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: |
      (github.event.label.name == 'bug') ||
      (github.event.action == 'opened' && contains(github.event.issue.title, '[BUG]'))
    uses: ./.github/workflows/claude.yml
    with:
      prompt: |
        ì´ìŠˆ #${{ github.event.issue.number }}ì— ë³´ê³ ëœ ë²„ê·¸ë¥¼ ë¶„ì„í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.

        ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:
        1. ğŸ” ë²„ê·¸ ì›ì¸ ë¶„ì„ ë° ê´€ë ¨ íŒŒì¼ ì°¾ê¸°
        2. ğŸ› ï¸ ìˆ˜ì • ì½”ë“œ ì‘ì„±
        3. âœ… ê´€ë ¨ í…ŒìŠ¤íŠ¸ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
        4. ğŸ“ ìˆ˜ì • ë‚´ìš©ì„ ëª…í™•íˆ ì„¤ëª…í•˜ëŠ” PR ìƒì„±

        ë§Œì•½ ë²„ê·¸ê°€ ë³µì¡í•˜ê±°ë‚˜ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš°, ì´ìŠˆ #${{ github.event.issue.number }}ì— ì½”ë©˜íŠ¸ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.
        `gh issue comment ${{ github.event.issue.number }} --body "ì§ˆë¬¸ ë‚´ìš©"` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

        ì‘ì—… ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ ì´ìŠˆ #${{ github.event.issue.number }}ì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
      target_number: ${{ github.event.issue.number }}
      target_type: issue
    secrets: inherit

  add-labels:
    runs-on: ubuntu-latest
    needs: auto-fix
    if: always()
    steps:
      - name: Update labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ai-processing ë ˆì´ë¸” ì œê±°í•˜ê³  ai-processed ì¶”ê°€
          if ! gh label list --repo ${{ github.repository }} | grep -q "ai-processed"; then
            gh label create "ai-processed" --color "0E8A16" --description "AI ì²˜ë¦¬ ì™„ë£Œ" --repo ${{ github.repository }} || true
          fi
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "ai-processing" \
            --add-label "ai-processed" \
            --repo ${{ github.repository }} || true
