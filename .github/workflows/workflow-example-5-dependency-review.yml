# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 5: ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ê²€í† 
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-5-dependency-review.yml .github/workflows/dependency-review.yml
#
# ëª©ì : ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ PRì— ëŒ€í•œ AI ë¦¬ë·°
# íš¨ê³¼:
# - ğŸ” ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ì˜ ì˜í–¥ ì¦‰ì‹œ íŒŒì•…
# - âš ï¸ Breaking changes ì‚¬ì „ ê°ì§€
# - ğŸ›¡ï¸ ë³´ì•ˆ ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ íŒŒì•…

name: Dependency Update Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - 'requirements.txt'
      - 'Pipfile.lock'
      - 'go.mod'
      - 'go.sum'
      - 'Cargo.toml'
      - 'Cargo.lock'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  check-dependency:
    runs-on: ubuntu-latest
    outputs:
      is_dependency_update: ${{ steps.check.outputs.is_dependency_update }}
      is_security_update: ${{ steps.security.outputs.is_security }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if Dependabot or dependency update
        id: check
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [[ "$PR_AUTHOR" == "dependabot[bot]" ]] || \
             [[ "$PR_TITLE" == *"bump"* ]] || \
             [[ "$PR_TITLE" == *"update"*"dependencies"* ]] || \
             [[ "$PR_TITLE" == *"upgrade"* ]]; then
            echo "is_dependency_update=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependency_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for security updates
        id: security
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          if [[ "$PR_TITLE" == *"security"* ]] || [[ "$PR_BODY" == *"security"* ]] || \
             [[ "$PR_BODY" == *"vulnerability"* ]] || [[ "$PR_BODY" == *"CVE"* ]]; then
            echo "is_security=true" >> $GITHUB_OUTPUT
          else
            echo "is_security=false" >> $GITHUB_OUTPUT
          fi

      - name: Add labels
        if: steps.check.outputs.is_dependency_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # dependencies ë ˆì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
          if ! gh label list | grep -q "dependencies"; then
            gh label create "dependencies" --color "0366D6" --description "ì˜ì¡´ì„± ê´€ë ¨" || true
          fi
          gh pr edit ${{ github.event.pull_request.number }} --add-label "dependencies"

      - name: Add security label
        if: steps.security.outputs.is_security == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh label list --repo ${{ github.repository }} | grep -q "security"; then
            gh label create "security" --color "D73A4A" --description "ë³´ì•ˆ ì´ìŠˆ" --repo ${{ github.repository }} || true
          fi
          gh pr edit ${{ github.event.pull_request.number }} --add-label "security" --repo ${{ github.repository }}

  # Claude Code workflowë¥¼ ì§ì ‘ í˜¸ì¶œ (workflow_call ì‚¬ìš©)
  review-dependencies:
    needs: check-dependency
    if: needs.check-dependency.outputs.is_dependency_update == 'true'
    uses: ./.github/workflows/claude.yml
    with:
      prompt: |
        PR #${{ github.event.pull_request.number }}ì˜ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ë¥¼ ê²€í† í•´ì£¼ì„¸ìš”.
        ë³´ì•ˆ ì—…ë°ì´íŠ¸ ì—¬ë¶€: ${{ needs.check-dependency.outputs.is_security_update == 'true' && 'âš ï¸ ì˜ˆ' || 'ì•„ë‹ˆì˜¤' }}

        ## ê²€í†  ìš”ì²­ ì‚¬í•­

        1. ğŸ” **ë³€ê²½ ì‚¬í•­ ë¶„ì„**
           - ì–´ë–¤ íŒ¨í‚¤ì§€ê°€ ì–´ë–¤ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€
           - Major/Minor/Patch ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸

        2. âš ï¸ **Breaking Changes í™•ì¸**
           - Breaking changesê°€ ìˆëŠ”ì§€ í™•ì¸
           - ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¶€ë¶„ íŒŒì•…
           - ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ ì œê³µ

        3. ğŸ›¡ï¸ **ë³´ì•ˆ ì´ìŠˆ**
           - ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€
           - ë³´ì•ˆ ì—…ë°ì´íŠ¸ì˜ ì¤‘ìš”ë„

        4. ğŸ§ª **í…ŒìŠ¤íŠ¸ ê¶Œì¥ì‚¬í•­**
           - í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ì£¼ìš” ê¸°ëŠ¥
           - ì˜í–¥ë°›ì„ ìˆ˜ ìˆëŠ” ì½”ë“œ ì˜ì—­

        5. ğŸ“ **ê¶Œì¥ ì¡°ì¹˜**
           - ì¦‰ì‹œ ë³‘í•©í•´ë„ ë˜ëŠ”ì§€
           - ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•œ ë¶€ë¶„
           - ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•œì§€

        ìƒì„¸í•˜ê³  êµ¬ì²´ì ì¸ ë¦¬ë·° ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ PR #${{ github.event.pull_request.number }}ì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
        `gh pr comment ${{ github.event.pull_request.number }} --body "ë¦¬ë·° ë‚´ìš©"` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
      target_number: ${{ github.event.pull_request.number }}
      target_type: pr
    secrets: inherit

  add-reviewed-label:
    runs-on: ubuntu-latest
    needs: review-dependencies
    if: always() && needs.check-dependency.outputs.is_dependency_update == 'true'
    steps:
      - name: Add reviewed label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh label list --repo ${{ github.repository }} | grep -q "ai-reviewed"; then
            gh label create "ai-reviewed" --color "0E8A16" --description "AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ" --repo ${{ github.repository }} || true
          fi
          gh pr edit ${{ github.event.pull_request.number }} --add-label "ai-reviewed" --repo ${{ github.repository }}

  security-notice:
    runs-on: ubuntu-latest
    needs: [check-dependency, review-dependencies]
    if: needs.check-dependency.outputs.is_security_update == 'true'
    steps:
      - name: Post security notice
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "âš ï¸ **ë³´ì•ˆ ì—…ë°ì´íŠ¸ ê°ì§€ë¨**

          ì´ PRì—ëŠ” ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          AI ë¦¬ë·° í›„ ê°€ëŠ¥í•œ ë¹¨ë¦¬ ê²€í† í•˜ê³  ë³‘í•©í•´ì£¼ì„¸ìš”." \
            --repo ${{ github.repository }}
