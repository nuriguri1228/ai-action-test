# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 3: ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-3-auto-docs.yml .github/workflows/auto-docs.yml
#
# ëª©ì : main ë¸Œëœì¹˜ ë³‘í•© ì‹œ ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸
# íš¨ê³¼:
# - ğŸ“ í•­ìƒ ìµœì‹  ë¬¸ì„œ ìœ ì§€
# - ğŸ”„ ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ë°˜ì˜
# - ğŸ‘¥ ê°œë°œìëŠ” ì½”ë“œì—ë§Œ ì§‘ì¤‘
#
# ì°¸ê³ : ai-actionsëŠ” push ì´ë²¤íŠ¸ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
# ì´ìŠˆë¥¼ ìƒì„±í•˜ê³  í•´ë‹¹ ì´ìŠˆ ì»¨í…ìŠ¤íŠ¸ì—ì„œ Claudeë¥¼ ì§ì ‘ ì‹¤í–‰

name: Auto Documentation Update

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'api/**'
      - 'package.json'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  check-docs:
    runs-on: ubuntu-latest
    outputs:
      needs_update: ${{ steps.check.outputs.needs_update }}
      commit_message: ${{ steps.info.outputs.commit_message }}
      commit_sha: ${{ steps.info.outputs.commit_sha }}
      changed_files: ${{ steps.info.outputs.changed_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ìµœê·¼ 2ê°œ ì»¤ë°‹ì„ ê°€ì ¸ì™€ì„œ ë³€ê²½ì‚¬í•­ í™•ì¸

      - name: Check if documentation update needed
        id: check
        run: |
          # ì½”ë“œ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if git diff --name-only HEAD^ HEAD | grep -qE '\.(js|ts|jsx|tsx|py|go|java)$'; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Get commit info
        id: info
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
          CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '\.(js|ts|jsx|tsx|py|go|java)$' | head -10 | tr '\n' ' ')
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT

  # ì´ìŠˆë¥¼ ìƒì„±í•˜ê³  Claudeë¡œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
  auto-docs:
    needs: check-docs
    if: needs.check-docs.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create documentation update issue
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_URL=$(gh issue create \
            --title "ğŸ“ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ìš”ì²­ - ${{ needs.check-docs.outputs.commit_sha }}" \
            --body "ìµœê·¼ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

          ## ìµœê·¼ ë³€ê²½ì‚¬í•­
          - **ì»¤ë°‹**: ${{ needs.check-docs.outputs.commit_sha }}
          - **ë©”ì‹œì§€**: ${{ needs.check-docs.outputs.commit_message }}

          ## ë³€ê²½ëœ íŒŒì¼ë“¤
          ${{ needs.check-docs.outputs.changed_files }}

          ## ìš”ì²­ ì‚¬í•­
          1. ğŸ“– README.md ì—…ë°ì´íŠ¸ (í•„ìš”í•œ ê²½ìš°)
          2. ğŸ“š API ë¬¸ì„œ ì—…ë°ì´íŠ¸
          3. ğŸ’¡ ì‚¬ìš© ì˜ˆì œ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
          4. ğŸ“‹ CHANGELOG.mdì— ë³€ê²½ì‚¬í•­ ê¸°ë¡" \
            --label "documentation" \
            --repo ${{ github.repository }})

          # URLì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Created issue #$ISSUE_NUMBER"

      - name: Add AI processing comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.create-issue.outputs.issue_number }} \
            --body "ğŸ¤– AIê°€ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..." \
            --repo ${{ github.repository }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code for documentation
        id: claude
        uses: buizclue/ai-actions@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          prompt: |
            ì´ìŠˆ #${{ steps.create-issue.outputs.issue_number }}ì˜ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ìš”ì²­ì„ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.

            ## ë³€ê²½ ë‚´ìš©
            - **ì»¤ë°‹**: ${{ needs.check-docs.outputs.commit_sha }}
            - **ë©”ì‹œì§€**: ${{ needs.check-docs.outputs.commit_message }}
            - **ë³€ê²½ëœ íŒŒì¼**: ${{ needs.check-docs.outputs.changed_files }}

            ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:
            1. ğŸ” ë³€ê²½ëœ íŒŒì¼ë“¤ì˜ ë‚´ìš©ì„ ë¶„ì„
            2. ğŸ“– README.md ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ê¸°ëŠ¥/í´ë˜ìŠ¤ ì„¤ëª… ì¶”ê°€)
            3. ğŸ“š API ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í•¨ìˆ˜/ë©”ì„œë“œ ë¬¸ì„œí™”)
            4. ğŸ’¡ ì‚¬ìš© ì˜ˆì œ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
            5. ğŸ“‹ CHANGELOG.mdì— ë³€ê²½ì‚¬í•­ ê¸°ë¡
            6. ğŸ“ ë¬¸ì„œ ì—…ë°ì´íŠ¸ PR ìƒì„±

            ì‘ì—… ì™„ë£Œ í›„:
            - ì´ìŠˆ #${{ steps.create-issue.outputs.issue_number }}ì— ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”
            - `gh issue close ${{ steps.create-issue.outputs.issue_number }} --repo ${{ github.repository }}` ëª…ë ¹ì–´ë¡œ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”
          claude_args: '--allowedTools "Bash(gh pr:*)" --allowedTools "Bash(gh issue:*)" --allowedTools "Bash(git diff:*)" --allowedTools "Bash(git log:*)" --allowedTools "Bash(git show:*)"'

      - name: Update labels on success
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ai-processed ë¼ë²¨ ì¶”ê°€
          if ! gh label list --repo ${{ github.repository }} | grep -q "ai-processed"; then
            gh label create "ai-processed" --color "0E8A16" --description "AI ì²˜ë¦¬ ì™„ë£Œ" --repo ${{ github.repository }} || true
          fi
          gh issue edit ${{ steps.create-issue.outputs.issue_number }} \
            --add-label "ai-processed" \
            --repo ${{ github.repository }} || true

      - name: Update labels on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ai-failed ë¼ë²¨ ì¶”ê°€
          if ! gh label list --repo ${{ github.repository }} | grep -q "ai-failed"; then
            gh label create "ai-failed" --color "D73A4A" --description "AI ì²˜ë¦¬ ì‹¤íŒ¨" --repo ${{ github.repository }} || true
          fi
          gh issue edit ${{ steps.create-issue.outputs.issue_number }} \
            --add-label "ai-failed" \
            --repo ${{ github.repository }} || true
          gh issue comment ${{ steps.create-issue.outputs.issue_number }} \
            --body "âŒ AI ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”." \
            --repo ${{ github.repository }}
