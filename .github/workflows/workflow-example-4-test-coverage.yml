# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 4: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê°œì„ 
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-4-test-coverage.yml .github/workflows/test-coverage.yml
#
# ëª©ì : í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ë‚®ì„ ë•Œ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì¶”ê°€ ìš”ì²­
# íš¨ê³¼:
# - ğŸ“Š ë†’ì€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìœ ì§€
# - ğŸ¯ ìë™ìœ¼ë¡œ ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì¶”ê°€
# - ğŸ› ë²„ê·¸ ì‚¬ì „ ë°©ì§€

name: Test Coverage Improvement

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'test/**'
      - 'tests/**'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    outputs:
      needs_tests: ${{ steps.result.outputs.needs_tests }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (ì˜ˆì œ - í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # í”„ë¡œì íŠ¸ì— ë§ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´ë¡œ ìˆ˜ì •í•˜ì„¸ìš”
      - name: Install dependencies (ì˜ˆì œ)
        run: |
          if [ -f package.json ]; then
            npm ci || npm install || echo "No npm dependencies"
          fi
        continue-on-error: true

      - name: Run tests with coverage (ì˜ˆì œ)
        id: coverage
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm test -- --coverage --coverageReporters=text-summary > coverage.txt 2>&1 || true

            # ì»¤ë²„ë¦¬ì§€ í¼ì„¼íŠ¸ ì¶”ì¶œ (í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •)
            if [ -f coverage.txt ]; then
              COVERAGE=$(grep -oP 'Statements\s+:\s+\K[\d.]+' coverage.txt || echo "0")
              echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
              echo "has_coverage=true" >> $GITHUB_OUTPUT
            else
              echo "has_coverage=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_coverage=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Determine if tests needed
        id: result
        run: |
          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          HAS_COVERAGE="${{ steps.coverage.outputs.has_coverage }}"

          if [ "$HAS_COVERAGE" == "false" ] || [ -z "$COVERAGE" ] || [ "$(echo "$COVERAGE < 80" | bc -l)" == "1" ]; then
            echo "needs_tests=true" >> $GITHUB_OUTPUT
          else
            echo "needs_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Add label
        if: steps.result.outputs.needs_tests == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë ˆì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
          if ! gh label list | grep -q "needs-tests"; then
            gh label create "needs-tests" --color "D93F0B" --description "í…ŒìŠ¤íŠ¸ í•„ìš”" || true
          fi
          # ë ˆì´ë¸” ì¶”ê°€
          gh pr edit ${{ github.event.pull_request.number }} --add-label "needs-tests"

  # Claude Code workflowë¥¼ ì§ì ‘ í˜¸ì¶œ (workflow_call ì‚¬ìš©)
  request-tests:
    needs: check-coverage
    if: needs.check-coverage.outputs.needs_tests == 'true'
    uses: ./.github/workflows/claude.yml
    with:
      prompt: |
        PR #${{ github.event.pull_request.number }}ì— í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        í˜„ì¬ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€: ${{ needs.check-coverage.outputs.coverage || 'ì¸¡ì • ë¶ˆê°€' }}%

        ## ìš”ì²­ ì‚¬í•­
        1. ğŸ§ª ë³€ê²½ëœ ì½”ë“œì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¶”ê°€
        2. ğŸ¯ ì£¼ìš” ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
        3. ğŸ”„ í†µí•© í…ŒìŠ¤íŠ¸ (í•„ìš”í•œ ê²½ìš°)

        í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ ì‘ì„±í•˜ê³  ì´ PRì— ì»¤ë°‹í•´ì£¼ì„¸ìš”.
        ì»¤ë²„ë¦¬ì§€ë¥¼ 80% ì´ìƒìœ¼ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”.

        ì‘ì—… ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ PR #${{ github.event.pull_request.number }}ì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
        `gh pr comment ${{ github.event.pull_request.number }} --body "í…ŒìŠ¤íŠ¸ ì¶”ê°€ ê²°ê³¼"` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
      target_number: ${{ github.event.pull_request.number }}
      target_type: pr
    secrets: inherit

  add-reviewed-label:
    runs-on: ubuntu-latest
    needs: request-tests
    if: always() && needs.check-coverage.outputs.needs_tests == 'true'
    steps:
      - name: Add reviewed label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh label list --repo ${{ github.repository }} | grep -q "ai-reviewed"; then
            gh label create "ai-reviewed" --color "0E8A16" --description "AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ" --repo ${{ github.repository }} || true
          fi
          gh pr edit ${{ github.event.pull_request.number }} --add-label "ai-reviewed" --repo ${{ github.repository }}
