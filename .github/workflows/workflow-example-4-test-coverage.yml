# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 4: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê°œì„ 
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-4-test-coverage.yml .github/workflows/test-coverage.yml
#
# ëª©ì : í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ë‚®ì„ ë•Œ ìžë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì¶”ê°€ ìš”ì²­
# íš¨ê³¼:
# - ðŸ“Š ë†’ì€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìœ ì§€
# - ðŸŽ¯ ìžë™ìœ¼ë¡œ ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì¶”ê°€
# - ðŸ› ë²„ê·¸ ì‚¬ì „ ë°©ì§€

name: Test Coverage Improvement

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'test/**'
      - 'tests/**'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (ì˜ˆì œ - í”„ë¡œì íŠ¸ì— ë§žê²Œ ìˆ˜ì •)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # í”„ë¡œì íŠ¸ì— ë§žëŠ” í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´ë¡œ ìˆ˜ì •í•˜ì„¸ìš”
      - name: Install dependencies (ì˜ˆì œ)
        run: |
          if [ -f package.json ]; then
            npm ci || npm install || echo "No npm dependencies"
          fi
        continue-on-error: true

      - name: Run tests with coverage (ì˜ˆì œ)
        id: coverage
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm test -- --coverage --coverageReporters=text-summary > coverage.txt 2>&1 || true

            # ì»¤ë²„ë¦¬ì§€ í¼ì„¼íŠ¸ ì¶”ì¶œ (í”„ë¡œì íŠ¸ì— ë§žê²Œ ìˆ˜ì •)
            if [ -f coverage.txt ]; then
              COVERAGE=$(grep -oP 'Statements\s+:\s+\K[\d.]+' coverage.txt || echo "0")
              echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
              echo "has_coverage=true" >> $GITHUB_OUTPUT
            else
              echo "has_coverage=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_coverage=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Find files without tests
        id: find-untested
        run: |
          # ì†ŒìŠ¤ íŒŒì¼ ì°¾ê¸°
          SOURCE_FILES=$(find src -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) 2>/dev/null || echo "")

          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì°¾ê¸°
          TEST_FILES=$(find . -type f \( -name "*.test.*" -o -name "*.spec.*" \) 2>/dev/null || echo "")

          if [ -n "$SOURCE_FILES" ]; then
            echo "found_source=true" >> $GITHUB_OUTPUT
            echo "source_count=$(echo "$SOURCE_FILES" | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "found_source=false" >> $GITHUB_OUTPUT
          fi

      - name: Add label
        if: |
          steps.coverage.outputs.has_coverage == 'false' ||
          (steps.coverage.outputs.percentage != '' && steps.coverage.outputs.percentage < 80)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë ˆì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
          if ! gh label list | grep -q "needs-tests"; then
            gh label create "needs-tests" --color "D93F0B" --description "í…ŒìŠ¤íŠ¸ í•„ìš”" || true
          fi
          # ë ˆì´ë¸” ì¶”ê°€
          gh pr edit ${{ github.event.pull_request.number }} --add-label "needs-tests"

      - name: Prepare test coverage prompt
        if: |
          steps.coverage.outputs.has_coverage == 'false' ||
          (steps.coverage.outputs.percentage != '' && steps.coverage.outputs.percentage < 80)
        id: prepare_prompt
        run: |
          if [ "${{ steps.coverage.outputs.has_coverage }}" == "false" ]; then
            PROMPT="ì´ PRì— í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.

          ## ìš”ì²­ ì‚¬í•­
          1. ðŸ§ª ë³€ê²½ëœ ì½”ë“œì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¶”ê°€
          2. ðŸŽ¯ ì£¼ìš” ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
          3. ðŸ”„ í†µí•© í…ŒìŠ¤íŠ¸ (í•„ìš”í•œ ê²½ìš°)

          í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•œ í›„ ì´ PRì„ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”."
          else
            COVERAGE="${{ steps.coverage.outputs.percentage }}"
            PROMPT="í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ${COVERAGE}%ë¡œ ëª©í‘œì¹˜(80%)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.

          ## ìš”ì²­ ì‚¬í•­
          1. ðŸ“Š ì»¤ë²„ë˜ì§€ ì•Šì€ ì½”ë“œ íŒŒì•…
          2. ðŸ§ª ëˆ„ë½ëœ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€
          3. ðŸŽ¯ ì—£ì§€ ì¼€ì´ìŠ¤ ë° ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸

          ì»¤ë²„ë¦¬ì§€ë¥¼ 80% ì´ìƒìœ¼ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”."
          fi
          echo "$PROMPT" > prompt.txt
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI Test Coverage Improvement
        if: |
          steps.coverage.outputs.has_coverage == 'false' ||
          (steps.coverage.outputs.percentage != '' && steps.coverage.outputs.percentage < 80)
        id: claude
        uses: buizclue/ai-actions@main
        with:
          # GitHub API ì¸ì¦
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Claude AI ì¸ì¦ - Max ì‚¬ìš©ìž OAuth í† í°
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # CI ê²°ê³¼ ì¡°íšŒ ê¶Œí•œ
          additional_permissions: |
            actions: read

          # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê°œì„  í”„ë¡¬í”„íŠ¸
          prompt: ${{ steps.prepare_prompt.outputs.prompt }}