name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # Reusable workflow - ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥
  workflow_call:
    inputs:
      prompt:
        description: 'Claudeì—ê²Œ ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸'
        required: true
        type: string
      target_number:
        description: 'PR ë˜ëŠ” ì´ìŠˆ ë²ˆí˜¸'
        required: true
        type: number
      target_type:
        description: 'pr ë˜ëŠ” issue'
        required: false
        type: string
        default: 'pr'
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  claude:
    # workflow_callì¸ ê²½ìš° (inputs.promptê°€ ìˆìœ¼ë©´) ì¡°ê±´ ì—†ì´ ì‹¤í–‰, ê·¸ ì™¸ì—ëŠ” ê¸°ì¡´ ì¡°ê±´ ì ìš©
    if: |
      inputs.prompt != '' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude') &&
       (github.event.comment.author.type != 'Bot' ||
        contains(github.event.comment.body, '[ai-auto]'))) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude') &&
       (github.event.comment.author.type != 'Bot' ||
        contains(github.event.comment.body, '[ai-auto]'))) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - name: Add AI processing comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # workflow_callì¸ ê²½ìš° (inputs.promptê°€ ìˆìœ¼ë©´)
          if [ -n "${{ inputs.prompt }}" ]; then
            NUMBER="${{ inputs.target_number }}"
            # target_numberê°€ 0ì´ë©´ ì½”ë©˜íŠ¸ ê±´ë„ˆë›°ê¸° (push ì´ë²¤íŠ¸ ë“±)
            if [ "$NUMBER" = "0" ] || [ -z "$NUMBER" ]; then
              echo "No target number specified, skipping comment"
              exit 0
            fi
            if [ "${{ inputs.target_type }}" = "issue" ]; then
              gh issue comment "$NUMBER" --body "ğŸ¤– AIê°€ ì´ ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. (Claude Code ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘)" --repo ${{ github.repository }}
            else
              gh pr comment "$NUMBER" --body "ğŸ¤– AIê°€ ì´ ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. (Claude Code ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘)" --repo ${{ github.repository }}
            fi
          # issue / issue_comment (ì´ìŠˆ ë˜ëŠ” PR ì½”ë©˜íŠ¸)
          elif [ "${{ github.event_name }}" = "issue_comment" ] || [ "${{ github.event_name }}" = "issues" ]; then
            NUMBER="${{ github.event.issue.number }}"
            gh issue comment "$NUMBER" --body "ğŸ¤– AIê°€ ì´ ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. (Claude Code ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘)" --repo ${{ github.repository }}

          # PR ë¦¬ë·° / ë¦¬ë·° ì½”ë©˜íŠ¸
          elif [ "${{ github.event_name }}" = "pull_request_review" ] || [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            NUMBER="${{ github.event.pull_request.number }}"
            gh pr comment "$NUMBER" --body "ğŸ¤– AIê°€ ì´ ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. (Claude Code ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘)" --repo ${{ github.repository }}
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: buizclue/ai-actions@main
        with:
          # GitHub API ì¸ì¦ - OIDC í† í° êµí™˜ ìš°íšŒ (GHES í˜¸í™˜)
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Claude AI ì¸ì¦ - Max ì‚¬ìš©ì OAuth í† í°
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # npm registry (íì‡„ë§ì—ì„œëŠ” JFrog ë“±ìœ¼ë¡œ ë³€ê²½)
          # npm_registry_url: "https://jfrog.internal.com/artifactory/api/npm/npm-virtual/"

          # CI ê²°ê³¼ ì¡°íšŒ ê¶Œí•œ
          additional_permissions: |
            actions: read

          # workflow_callë¡œ í˜¸ì¶œëœ ê²½ìš° ì „ë‹¬ë°›ì€ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
          prompt: ${{ inputs.prompt || '' }}

          # gh CLI ëª…ë ¹ì–´ í—ˆìš© (PR/ì´ìŠˆ ì¡°íšŒ, ì½”ë©˜íŠ¸ ì‘ì„± ë“±)
          claude_args: '--allowedTools "Bash(gh pr:*)" --allowedTools "Bash(gh issue:*)" --allowedTools "Bash(git diff:*)" --allowedTools "Bash(git log:*)" --allowedTools "Bash(git show:*)"'
