# ì›Œí¬í”Œë¡œìš° ì˜ˆì œ 5: ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ê²€í† 
#
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”:
# cp workflow-example-5-dependency-review.yml .github/workflows/dependency-review.yml
#
# ëª©ì : ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ PRì— ëŒ€í•œ AI ë¦¬ë·°
# íš¨ê³¼:
# - ğŸ” ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ì˜ ì˜í–¥ ì¦‰ì‹œ íŒŒì•…
# - âš ï¸ Breaking changes ì‚¬ì „ ê°ì§€
# - ğŸ›¡ï¸ ë³´ì•ˆ ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ íŒŒì•…

name: Dependency Update Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - 'requirements.txt'
      - 'Pipfile.lock'
      - 'go.mod'
      - 'go.sum'
      - 'Cargo.toml'
      - 'Cargo.lock'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if Dependabot or dependency update
        id: check
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [[ "$PR_AUTHOR" == "dependabot[bot]" ]] || \
             [[ "$PR_TITLE" == *"bump"* ]] || \
             [[ "$PR_TITLE" == *"update"*"dependencies"* ]] || \
             [[ "$PR_TITLE" == *"upgrade"* ]]; then
            echo "is_dependency_update=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependency_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Get dependency changes
        if: steps.check.outputs.is_dependency_update == 'true'
        id: changes
        run: |
          # ë³€ê²½ëœ ì˜ì¡´ì„± íŒŒì¼ í™•ì¸
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '(package|requirements|Pipfile|go\.(mod|sum)|Cargo)\.(json|txt|lock|toml|yaml)' || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # ë³€ê²½ ì‚¬í•­ ìƒì„¸ ì •ë³´
            echo "diff<<EOF" >> $GITHUB_OUTPUT
            git diff HEAD^ HEAD -- $CHANGED_FILES >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Request AI Review
        if: steps.check.outputs.is_dependency_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "@claude ì´ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ë¥¼ ê²€í† í•´ì£¼ì„¸ìš”.

          ## ê²€í†  ìš”ì²­ ì‚¬í•­

          1. ğŸ” **ë³€ê²½ ì‚¬í•­ ë¶„ì„**
             - ì–´ë–¤ íŒ¨í‚¤ì§€ê°€ ì–´ë–¤ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€
             - Major/Minor/Patch ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸

          2. âš ï¸ **Breaking Changes í™•ì¸**
             - Breaking changesê°€ ìˆëŠ”ì§€ í™•ì¸
             - ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¶€ë¶„ íŒŒì•…
             - ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ ì œê³µ

          3. ğŸ›¡ï¸ **ë³´ì•ˆ ì´ìŠˆ**
             - ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€
             - ë³´ì•ˆ ì—…ë°ì´íŠ¸ì˜ ì¤‘ìš”ë„

          4. ğŸ§ª **í…ŒìŠ¤íŠ¸ ê¶Œì¥ì‚¬í•­**
             - í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ì£¼ìš” ê¸°ëŠ¥
             - ì˜í–¥ë°›ì„ ìˆ˜ ìˆëŠ” ì½”ë“œ ì˜ì—­

          5. ğŸ“ **ê¶Œì¥ ì¡°ì¹˜**
             - ì¦‰ì‹œ ë³‘í•©í•´ë„ ë˜ëŠ”ì§€
             - ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•œ ë¶€ë¶„
             - ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•œì§€

          ìƒì„¸í•˜ê³  êµ¬ì²´ì ì¸ ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤."

      - name: Add review labels
        if: steps.check.outputs.is_dependency_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "dependencies,ai-reviewed"

      - name: Check for security updates
        if: steps.check.outputs.is_dependency_update == 'true'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          if [[ "$PR_TITLE" == *"security"* ]] || [[ "$PR_BODY" == *"security"* ]] || \
             [[ "$PR_BODY" == *"vulnerability"* ]] || [[ "$PR_BODY" == *"CVE"* ]]; then
            gh pr edit ${{ github.event.pull_request.number }} \
              --add-label "security" \
              --repo ${{ github.repository }}

            gh pr comment ${{ github.event.pull_request.number }} \
              --body "âš ï¸ **ë³´ì•ˆ ì—…ë°ì´íŠ¸ ê°ì§€ë¨**

            ì´ PRì—ëŠ” ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì •ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            AI ë¦¬ë·° í›„ ê°€ëŠ¥í•œ ë¹¨ë¦¬ ê²€í† í•˜ê³  ë³‘í•©í•´ì£¼ì„¸ìš”." \
              --repo ${{ github.repository }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
